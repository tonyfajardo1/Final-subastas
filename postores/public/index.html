<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Portal de Postores</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<h1>ğŸ‘¥ Bienvenido al Portal de Postores</h1>

<h2>Registro de Postor</h2>
<input type="text" id="nombrePostor" placeholder="Tu nombre">
<select id="subastaSelect">
    <option value="1">The Mona Lisa</option>
    <option value="2">Starry Night</option>
    <option value="3">The Persistence of Memory</option>
</select>
<button onclick="registrarPostor()">Registrarse</button>

<h2>Realizar Oferta</h2>
<input type="number" id="montoOferta" placeholder="Monto de la oferta">
<button onclick="enviarOferta()">Ofertar</button>

<h2>Estado</h2>
<div id="estadoSubasta"></div>

<script>
    let estadoActual = null;
    let subastaIdSeleccionada = 1;
    let postoresActuales = [];
    const socket = new WebSocket("ws://localhost:8080");

    // ConexiÃ³n WebSocket
    socket.addEventListener("open", () => {
        console.log("ğŸŸ¢ Conectado al WebSocket del manejador");
    });

    socket.addEventListener("message", (event) => {
        const mensaje = JSON.parse(event.data);

        // ğŸ”¥ Escuchar todos los tipos de mensajes
        if (mensaje.tipo === "ofertaNueva" && mensaje.payload.subastaId === subastaIdSeleccionada) {
            console.log("ğŸ“¢ Nueva oferta recibida:", mensaje.payload);
            actualizarEstado();
        }

        if (mensaje.tipo === "subastaTerminada" && mensaje.payload.subastaId === subastaIdSeleccionada) {
            console.log("ğŸ† Subasta terminada:", mensaje.payload);
            alert(`ğŸ† Subasta terminada. ${mensaje.payload.ganador ? "Ganador: " + mensaje.payload.ganador + " con $" + mensaje.payload.monto : "No hubo ganador."}`);
            actualizarEstado();
        }

        if (mensaje.tipo === "postoresUpdate" && mensaje.payload.subastaId === subastaIdSeleccionada) {
            console.log("ğŸ“ Postores actualizados:", mensaje.payload.postores);
            actualizarEstado();
        }
    });

    async function registrarPostor() {
        const nombre = document.getElementById('nombrePostor').value.trim();
        subastaIdSeleccionada = parseInt(document.getElementById('subastaSelect').value);

        if (nombre === "") {
            alert("âŒ Ingresa tu nombre para registrarte");
            return;
        }

        const estado = await obtenerEstadoSubasta(subastaIdSeleccionada);
        if (!estado.activa) {
            alert("âŒ No puedes registrarte en una subasta que no estÃ¡ activa");
            return;
        }

        try {
            const response = await fetch("/registrar-postor", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ nombre, subastaId: subastaIdSeleccionada })
            });

            if (!response.ok) throw new Error("Error registrando postor");
            const data = await response.json();
            alert("âœ… Registro exitoso");
            console.log(data);

            actualizarEstado();
        } catch (error) {
            console.error(error);
            alert("âŒ Error registrando postor");
        }
    }

    async function enviarOferta() {
        const nombre = document.getElementById('nombrePostor').value.trim();
        const monto = parseFloat(document.getElementById('montoOferta').value.trim());

        if (!nombre || isNaN(monto)) {
            alert("âŒ Debes ingresar tu nombre y un monto vÃ¡lido");
            return;
        }

        if (!estadoActual) {
            alert("âŒ No se ha cargado el estado de la subasta");
            return;
        }

        const estado = await obtenerEstadoSubasta(subastaIdSeleccionada);
        if (!estado.activa) {
            alert("âŒ No puedes ofertar en una subasta que no estÃ¡ activa");
            return;
        }

        let precioActual;
        if (estadoActual.ofertas.length === 0) {
            precioActual = estadoActual.precioBase;
        } else {
            const ultimaOferta = estadoActual.ofertas[estadoActual.ofertas.length - 1];
            precioActual = ultimaOferta.monto;
        }

        if (monto <= precioActual) {
            alert(`âŒ Tu oferta debe ser mayor a $${precioActual}`);
            return;
        }

        try {
            const response = await fetch("/ofertar", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ nombre, monto, subastaId: subastaIdSeleccionada })
            });

            if (!response.ok) throw new Error("Error enviando oferta");
            const data = await response.json();
            alert("âœ… Oferta enviada exitosamente");
            console.log(data);

            actualizarEstado();
        } catch (error) {
            console.error(error);
            alert("âŒ Error enviando oferta");
        }
    }

    async function obtenerEstadoSubasta(id) {
        try {
            const response = await fetch(`/estado-subasta/${id}`);
            const data = await response.json();
            return data;
        } catch (error) {
            console.error("Error al obtener estado de subasta:", error);
            return { activa: false };
        }
    }

    async function actualizarEstado() {
        try {
            const response = await fetch(`/estado-subasta/${subastaIdSeleccionada}`);
            const data = await response.json();
            estadoActual = data;
            postoresActuales = data.ofertas || []; // Actualizar ofertas
            renderizarEstado();
        } catch (error) {
            console.error("Error al actualizar estado:", error);
        }
    }

    function renderizarEstado() {
        if (!estadoActual) return;

        let estadoHTML = "";

        if (estadoActual.activa) {
            estadoHTML += `<p>â³ Subasta en progreso...</p>`;
            estadoHTML += `<p>â° Tiempo restante: ${estadoActual.restante} segundos</p>`;
        } else {
            if (estadoActual.ganador) {
                estadoHTML += `<p>ğŸ† Subasta finalizada</p>`;
                estadoHTML += `<p>Ganador: <strong>${estadoActual.ganador}</strong> con una oferta de <strong>$${estadoActual.oferta}</strong></p>`;
            } else {
                estadoHTML += `<p>âŒ Subasta finalizada sin ganador</p>`;
            }
        }

        if (postoresActuales.length > 0) {
            estadoHTML += `<h3>ğŸ“ Postores registrados:</h3><ul>`;
            postoresActuales.forEach(oferta => {
                estadoHTML += `<li><strong>${oferta.nombre}</strong> ofertÃ³ <strong>$${oferta.monto}</strong></li>`;
            });
            estadoHTML += `</ul>`;
        } else {
            estadoHTML += `<p>ğŸ“ No hay ofertas aÃºn.</p>`;
        }

        document.getElementById("estadoSubasta").innerHTML = estadoHTML;
    }

    setInterval(actualizarEstado, 5000); // cada 5 segundos
    actualizarEstado();
</script>

</body>
</html>
