<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Manejador de Subastas</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .subasta {
            border: 1px solid black;
            padding: 15px;
            margin-bottom: 20px;
        }
        img {
            width: 150px;
            height: auto;
        }
    </style>
</head>
<body>
<h1>🎯 Bienvenido al Manejador de Subastas</h1>

<button onclick="iniciarSubastasSecuencialmente()">Iniciar Todas las Subastas</button>
<div id="listaSubastas"></div>
<h2 id="estadoSubasta"></h2>

<script>
    let intervalo;
    let subastaActiva = null;
    let subastasGlobal = [];

    async function cargarSubastas() {
        try {
            const response = await fetch("/subastas");
            const data = await response.json();
            subastasGlobal = data;
            renderizarSubastas(data);
        } catch (error) {
            console.error("Error cargando subastas:", error);
        }
    }

    function renderizarSubastas(subastas) {
        const contenedor = document.getElementById("listaSubastas");
        contenedor.innerHTML = "";

        subastas.forEach(subasta => {
            const div = document.createElement("div");
            div.className = "subasta";
            div.id = `subasta-${subasta.id}`;

            div.innerHTML = `
                <h2>${subasta.titulo}</h2>
                <p><b>Artista:</b> ${subasta.artista}</p>
                <img src="${subasta.imagen}" alt="${subasta.titulo}">
                <p><b>Precio base actual:</b> $<span id="precio-${subasta.id}">${subasta.precioBase}</span></p>
                <input type="number" id="nuevoPrecio-${subasta.id}" placeholder="Nuevo precio base">
                <button onclick="editarPrecio(${subasta.id})">Editar Precio Base</button>
                <button onclick="verDetalles(${subasta.id})">Ver Detalles</button>
            `;
            contenedor.appendChild(div);
        });
    }

    function verDetalles(subastaId) {
    // Redirige a la página de detalles con el ID en la URL
    window.location.href = `detalles.html?id=${subastaId}`;
}

    async function editarPrecio(subastaId) {
        const nuevoPrecio = document.getElementById(`nuevoPrecio-${subastaId}`).value;

        if (nuevoPrecio.trim() === "") {
            alert("❌ Ingresa un nuevo precio");
            return;
        }

        try {
            const response = await fetch("/editar-precio", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ subastaId, nuevoPrecio })
            });

            if (!response.ok) throw new Error("Error editando precio");

            document.getElementById(`precio-${subastaId}`).innerText = nuevoPrecio;
            alert("✅ Precio editado correctamente");
        } catch (error) {
            alert("❌ Error al editar precio");
            console.error(error);
        }
    }

    async function iniciarSubasta(subastaId) {
        if (subastaActiva) return;

        try {
            const response = await fetch("/iniciar-subasta", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ subastaId })
            });

            if (!response.ok) throw new Error("Error iniciando subasta");

            subastaActiva = subastaId;
            intervalo = setInterval(() => actualizarEstadoSubasta(subastaId), 1000);
        } catch (error) {
            console.error("❌ Error al iniciar subasta:", error);
        }
    }

    async function actualizarEstadoSubasta(subastaId) {
        try {
            const response = await fetch(`/estado-subasta/${subastaId}`);
            const data = await response.json();
            const estado = document.getElementById("estadoSubasta");

            if (data.activa) {
                estado.innerHTML = `⏳ Subasta en progreso (ID ${subastaId})...<br>⏰ Tiempo restante: ${data.restante} segundos`;
            } else {
                clearInterval(intervalo);
                subastaActiva = null;

                if (data.ganador) {
                    estado.innerHTML = `🏆 Subasta #${subastaId} terminada. Ganador: <b>${data.ganador}</b> con una oferta de <b>$${data.oferta}</b>`;
                } else {
                    estado.innerHTML = `❌ Subasta #${subastaId} terminada sin ganador.`;
                }

                // Avanzar a la siguiente
                siguienteSubasta();
                cargarSubastas(); // Para refrescar precios
            }
        } catch (error) {
            console.error("❌ Error al actualizar estado:", error);
        }
    }

    let subastasPendientes = [];

    function iniciarSubastasSecuencialmente() {
        if (subastaActiva) {
            alert("❌ Espera a que termine la subasta actual.");
            return;
        }
        subastasPendientes = [...subastasGlobal]; // Copia de todas las subastas
        siguienteSubasta();
    }

    function siguienteSubasta() {
        if (subastasPendientes.length === 0) {
            document.getElementById("estadoSubasta").innerHTML = "✅ Todas las subastas han finalizado.";
            return;
        }
        const siguiente = subastasPendientes.shift(); // Obtener la siguiente
        iniciarSubasta(siguiente.id);
    }

    cargarSubastas();
</script>
</body>
</html>
